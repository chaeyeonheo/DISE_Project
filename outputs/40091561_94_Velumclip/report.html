
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DISE Clinical Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Manrope', sans-serif; background: #f8fafc; color: #1e293b; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Modern Card Utility */
        .card { background: white; border-radius: 1.5rem; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02); transition: transform 0.2s; }
        .card:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025); }
        
        /* Grade Badges */
        .badge { padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.7rem; font-weight: 700; letter-spacing: 0.05em; text-transform: uppercase; }
        .badge-g2 { background: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }
        .badge-g1 { background: #fff7ed; color: #c2410c; border: 1px solid #fed7aa; }
        .badge-g0 { background: #f0fdf4; color: #15803d; border: 1px solid #bbf7d0; }
        
        /* Row Hover Colors for Table */
        .hover-row-g2:hover { background-color: #fef2f2; }
        .hover-row-g1:hover { background-color: #fff7ed; }
        .hover-row-g0:hover { background-color: #f0fdf4; }

        /* Layout Utilities */
        .glass-header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid #e2e8f0; }
        
        /* Chat Animation */
        .chat-slide-enter { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .chat-slide-exit { animation: slideDown 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px) scale(0.96); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes slideDown { from { opacity: 1; transform: translateY(0) scale(1); } to { opacity: 0; transform: translateY(20px) scale(0.96); } }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="selection:bg-indigo-100 selection:text-indigo-900">

    <nav class="fixed top-0 w-full z-40 glass-header h-16 flex items-center px-6 lg:px-12 justify-between">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-lg flex items-center justify-center text-white shadow-md">
                <i class="fas fa-wave-square text-xs"></i>
            </div>
            <span class="font-bold text-lg tracking-tight text-slate-800">DISE <span class="text-indigo-600">Analytics</span></span>
        </div>
        <div class="flex items-center gap-6">
            <div class="text-right">
                <p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Exam Date</p>
                <p class="text-sm font-bold text-slate-900">2025-12-06</p>
            </div>
            <div class="h-8 w-px bg-slate-200"></div>
            <div class="text-right">
                <p class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Patient ID</p>
                <p class="text-sm font-bold text-slate-900">40091561_94_Velumclip</p>
            </div>
        </div>
    </nav>

    <main class="pt-24 pb-20 px-6 lg:px-12 max-w-[1600px] mx-auto space-y-8">
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="card p-6 flex flex-col justify-between relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:scale-110 transition-transform"><i class="fas fa-user-circle text-6xl text-indigo-500"></i></div>
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Patient</p>
                    <h3 class="text-xl font-bold text-slate-800 mt-1">56 <span class="text-sm font-normal text-slate-500">Years</span> / M</h3>
                </div>
                <div class="mt-4 pt-4 border-t border-slate-100">
                    <p class="text-xs text-slate-500">Diagnosis</p>
                    <p class="text-sm font-bold text-indigo-600 truncate">sleepapnea</p>
                </div>
            </div>

            <div class="card p-6 flex flex-col justify-between relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:scale-110 transition-transform"><i class="fas fa-exclamation-triangle text-6xl text-rose-500"></i></div>
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Total Events</p>
                    <h3 class="text-4xl font-extrabold text-slate-900 mt-1 font-mono">4</h3>
                </div>
                <div class="mt-4 flex gap-2">
                    <span class="px-2 py-1 rounded bg-red-50 text-red-700 text-xs font-bold border border-red-100">4 Complete</span>
                    <span class="px-2 py-1 rounded bg-orange-50 text-orange-700 text-xs font-bold border border-orange-100">0 Partial</span>
                    <span class="px-2 py-1 rounded bg-green-50 text-green-700 text-xs font-bold border border-green-100">0 Open</span>
                </div>
            </div>

             <div class="card p-6 flex flex-col justify-between relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:scale-110 transition-transform"><i class="fas fa-lungs text-6xl text-emerald-500"></i></div>
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">AHI Score</p>
                    <h3 class="text-4xl font-extrabold text-slate-900 mt-1 font-mono">43.8</h3>
                </div>
                 <div class="mt-4 pt-4 border-t border-slate-100">
                    <p class="text-xs text-slate-500">Reference Max Area</p>
                    <p class="text-sm font-bold text-slate-700">441850 px²</p>
                </div>
            </div>
            
            <div class="card p-6 flex flex-col justify-between relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:scale-110 transition-transform"><i class="fas fa-chart-area text-6xl text-purple-500"></i></div>
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Dominant Region</p>
                    <h3 class="text-3xl font-bold text-slate-900 mt-1">Velum</h3>
                </div>
                 <div class="mt-4 pt-4 border-t border-slate-100">
                    <p class="text-xs text-slate-500">Video Duration</p>
                    <p class="text-sm font-bold text-slate-700">22.0 sec</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 card p-8 border-l-4 border-l-indigo-600 bg-gradient-to-br from-white to-slate-50">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600">
                        <i class="fas fa-robot text-lg"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-slate-800">AI Clinical Insight</h2>
                        <p class="text-xs text-slate-500">Automated analysis summary based on visual occlusion grading</p>
                    </div>
                </div>
                <div class="prose prose-sm max-w-none text-slate-700 leading-relaxed">
                    ## DISE 판독 소견서<br><br>**환자명:** M / 56세<br>**영상 파일명:** 40091561_94_Velumclip.mp4<br>**영상 길이:** 22.0초<br>**시행일:** YYYY년 MM월 DD일 (가정)<br>**판독의:** OOO 이비인후과 전문의<br><br>---<br><br>### 1. 환자 개요 및 중증도 평가<br><br>환자 M/56세는 수면무호흡증을 기저 질환으로 가지고 있으며, AHI 43.8로 중증 수면무호흡증에 해당합니다. 본 DISE(Drug-induced Sleep Endoscopy)는 상기도 폐쇄 부위 및 형태를 정밀하게 파악하여 맞춤형 치료 계획을 수립하기 위해 시행되었습니다. 환자의 높은 AHI는 수면 중 심한 상기도 폐쇄가 반복적으로 발생하고 있음을 시사하며, DISE를 통해 해당 폐쇄의 해부학적 양상을 확인하고자 합니다.<br><br>### 2. 부위별(OTE/Velum) 폐색 패턴 분석 (Visual Occlusion 등급 기준 사용)<br><br>본 22.0초 길이의 DISE 영상 분석 결과, 주요 상기도 폐쇄는 **연구개(Velum) 영역에서만** 관찰되었습니다. 구개편도(Oropharynx, Tonsil, Epiglottis; OTE) 영역에서는 의미 있는 폐쇄 이벤트가 감지되지 않았습니다.<br><br>감지된 총 4개의 폐색 이벤트는 모두 연구개(Velum)에서 발생하였으며, 상세 분석 결과 모두 Visual Occlusion 등급 기준에 따라 **Grade 2 (완전 폐쇄, >75%)** 에 해당합니다. 이는 데이터에 명시된 'Critical' 등급이 90% 이상의 최대 감소율을 보인 점을 고려할 때 완전 폐쇄로 분류됩니다.<br><br>*   **이벤트 #1 (Velum):** 0.0s ~ 4.0s (지속시간 4.0s), 최대 감소율 99.8% (Grade 2)<br>*   **이벤트 #2 (Velum):** 6.0s ~ 9.0s (지속시간 3.0s), 최대 감소율 98.5% (Grade 2)<br>*   **이벤트 #3 (Velum):** 13.0s ~ 15.0s (지속시간 2.0s), 최대 감소율 94.8% (Grade 2)<br>*   **이벤트 #4 (Velum):** 19.0s ~ 21.0s (지속시간 2.0s), 최대 감소율 91.2% (Grade 2)<br><br>**참고:** 분석 요약의 '등급별 분포: Grade 2 (Complete, >75%): 0개'와는 달리, 상세 감지된 이벤트의 최대 감소율은 모두 90% 이상으로 Grade 2에 해당함을 명확히 확인하였습니다.<br><br>### 3. Grade 2(완전 폐쇄) 발생 빈도 및 지속시간에 대한 임상적 해석<br><br>환자는 수면 중 연구개 부위에서 반복적으로 발생하는 빈번하고 심한 완전 폐쇄(Grade 2)를 보이고 있습니다. 짧은 영상 내에서 4회에 걸쳐 90% 이상의 심한 협착이 관찰되었으며, 가장 긴 폐쇄는 4.0초에 달했습니다. 이러한 빈번하고 비교적 긴 시간의 완전 폐쇄는 수면 중 기도를 심각하게 차단하여 산소포화도 저하 및 뇌 각성(arousal)을 유발하고, 환자의 중증 AHI(43.8)에 상당한 기여를 할 것으로 판단됩니다.<br><br>특히 연구개 부위의 이러한 역동적이고 광범위한 완전 폐쇄는 상기도 개방성 유지에 큰 어려움을 초래하며, 이는 주간 졸림, 피로, 인지 기능 저하 등 수면무호흡증 관련 증상과 밀접한 관련이 있을 것으로 예상됩니다.<br><br>### 4. 종합 평가 및 치료 제안<br><br>본 환자의 DISE 결과, 중증 수면무호흡증의 주된 해부학적 원인은 **연구개(Velum) 부위의 심각하고 반복적인 완전 폐쇄(Grade 2)** 입니다. 다른 부위(OTE)의 폐쇄는 관찰되지 않아 연구개가 주된 치료 표적이 되어야 함을 알 수 있습니다.<br><br>이를 바탕으로 다음과 같은 맞춤형 치료를 제안합니다.<br><br>1.  **수술적 치료 고려:** 연구개 부위의 완전 폐쇄 양상과 매우 높은 폐쇄율을 고려할 때, 이 부위에 대한 적극적인 수술적 치료를 우선적으로 고려해야 합니다. 연구개 성형술(Uvulopalatopharyngoplasty, UPPP), 구개확장 인두성형술(Expansion pharyngoplasty), 또는 연성 구개 조직의 긴장도를 높이는 술식(Palatal stiffening procedures) 등을 통한 기도의 확장이 필요할 것으로 사료됩니다. 특히 연구개의 후방 이동으로 인한 폐쇄 양상에 따라 효과적인 수술 방법을 선택해야 합니다.<br>2.  **환자 상담:** 수술적 치료의 목표, 기대 효과, 잠재적 위험 및 회복 과정에 대해 환자에게 상세히 설명하고, 환자의 선호도와 전신 건강 상태를 종합적으로 고려하여 최종 치료 계획을 수립합니다.<br>3.  **사후 관리:** 수술 후에도 지속적인 AHI 개선 여부 및 증상 완화를 평가하고, 필요한 경우 CPAP 또는 구강 장치와 같은 보조적 치료를 병행하여 최적의 결과를 도모합니다.<br><br>---<br>**[종합 의견]**<br>M/56세 환자는 중증 수면무호흡증의 주된 원인으로 연구개 부위의 심각하고 반복적인 완전 폐쇄를 보이며, 이에 대한 수술적 개입이 가장 효과적인 치료 방안이 될 것으로 판단됩니다.
                </div>
            </div>

            <div class="lg:col-span-1 flex flex-col gap-4">
                <div class="card p-6 h-full">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Reference Anatomy</h3>
                    <div class='grid grid-cols-1 gap-4'>
                    <div class="relative group rounded-2xl overflow-hidden border border-slate-200 shadow-sm transition-all hover:shadow-md">
                        <div class="absolute top-3 left-3 bg-sky-500 text-white text-[10px] font-bold px-2.5 py-1 rounded-full shadow-sm z-10">OTE</div>
                        <div class="w-full aspect-[4/3] bg-slate-100">
                            <img src="overlays/reference_OTE.jpg" class="w-full h-full object-cover">
                        </div>
                        <div class="bg-white p-2 border-t border-slate-50 text-right">
                             <span class="text-xs font-bold text-slate-700">441850 px²</span>
                        </div>
                    </div>
                    <div class="relative group rounded-2xl overflow-hidden border border-slate-200 shadow-sm transition-all hover:shadow-md">
                        <div class="absolute top-3 left-3 bg-purple-500 text-white text-[10px] font-bold px-2.5 py-1 rounded-full shadow-sm z-10">Velum</div>
                        <div class="w-full aspect-[4/3] bg-slate-100">
                            <img src="overlays/reference_Velum.jpg" class="w-full h-full object-cover">
                        </div>
                        <div class="bg-white p-2 border-t border-slate-50 text-right">
                             <span class="text-xs font-bold text-slate-700">358029 px²</span>
                        </div>
                    </div></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 card p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-slate-800 text-lg">Timeline Analysis</h3>
                    <span class="text-xs font-mono bg-slate-100 px-2 py-1 rounded text-slate-500">Interactive Plot</span>
                </div>
                <img src="timeline.png" class="w-full rounded-xl border border-slate-100 shadow-sm">
                <div class="mt-4 p-4 bg-slate-50 rounded-xl border border-slate-100 flex gap-3 items-start">
                    <i class="fas fa-info-circle text-indigo-500 mt-0.5"></i>
                    <p class="text-xs text-slate-600 leading-relaxed"><strong>Interpretation:</strong> 환자는 22초 영상 촬영 동안 벨룸 부위에서 총 4차례에 걸쳐 90% 이상의 심각한 감소율을 보이는 'Critical' 등급(Grade 2에 해당)의 완전 폐쇄가 반복적으로 나타났으며, 시간에 따른 폐쇄 등급의 변화는 관찰되지 않았습니다.</p>
                </div>
            </div>

            <div class="lg:col-span-1 card p-6 flex flex-col">
                <h3 class="font-bold text-slate-800 text-lg mb-6">Severity Distribution</h3>
                <div class="flex-1 flex items-center justify-center p-4 bg-slate-50 rounded-xl border border-slate-100 border-dashed">
                    <img src="severity_chart.png" class="max-h-[250px] object-contain">
                </div>
                 <div class="mt-4 p-4 bg-slate-50 rounded-xl border border-slate-100 flex gap-3 items-start">
                    <i class="fas fa-chart-pie text-orange-500 mt-0.5"></i>
                    <p class="text-xs text-slate-600 leading-relaxed"><strong>Interpretation:</strong> 제시된 등급별 분포에는 폐쇄 이벤트가 없다고 되어 있으나, 상세 분석 결과 모든 4개의 폐색 이벤트는 벨룸 부위에서 최대 감소율이 91.2%에서 99.8%에 달하는 'Critical' 등급으로, 이는 모두 Grade 2 (완전 폐쇄)에 해당하여 매우 심각한 폐쇄를 보인다.</p>
                </div>
            </div>
        </div>

        <div class="card overflow-hidden">
            <div class="px-8 py-6 border-b border-slate-100 flex justify-between items-center bg-white">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-rose-50 flex items-center justify-center text-rose-500">
                        <i class="fas fa-list-ul"></i>
                    </div>
                    <h3 class="font-bold text-lg text-slate-800">Event Logs</h3>
                </div>
                <div class="flex gap-2">
                     <span class="px-3 py-1 bg-slate-100 rounded-full text-xs font-bold text-slate-600 border border-slate-200">4 Events Detected</span>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-50/50 border-b border-slate-100 text-xs uppercase text-slate-400 font-bold tracking-wider">
                            <th class="px-8 py-4">Severity Grade</th>
                            <th class="px-6 py-4">Anatomy</th>
                            <th class="px-6 py-4">Timestamp</th>
                            <th class="px-6 py-4">Duration</th>
                            <th class="px-6 py-4">Max Reduction</th>
                            <th class="px-6 py-4 text-center">Replay</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-50 text-sm">
        
                <tr onclick="playVideo('event_clips/event_01_Velum_Critical.mp4', 'Critical - Velum')" class="hover-row-g0 transition-colors cursor-pointer group">
                    <td class="px-8 py-4">
                        <span class="badge badge-g0">Critical</span>
                    </td>
                    <td class="px-6 py-4 font-bold text-slate-700">Velum</td>
                    <td class="px-6 py-4 text-slate-500 font-mono text-xs">
                        <i class="far fa-clock mr-1 opacity-50"></i>0.0s — 4.0s
                    </td>
                    <td class="px-6 py-4 text-slate-600 font-medium">4.0s</td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2">
                            <div class="w-16 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                                <div class="h-full bg-rose-500" style="width: 99.79526798108533%"></div>
                            </div>
                            <span class="font-bold text-rose-600 text-xs">100%</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <button class="w-8 h-8 rounded-full bg-white border border-slate-200 text-slate-400 group-hover:bg-indigo-600 group-hover:text-white group-hover:border-indigo-600 transition-all shadow-sm">
                            <i class="fas fa-play text-[10px] pl-0.5"></i>
                        </button>
                    </td>
                </tr>
                
                <tr onclick="playVideo('event_clips/event_02_Velum_Critical.mp4', 'Critical - Velum')" class="hover-row-g0 transition-colors cursor-pointer group">
                    <td class="px-8 py-4">
                        <span class="badge badge-g0">Critical</span>
                    </td>
                    <td class="px-6 py-4 font-bold text-slate-700">Velum</td>
                    <td class="px-6 py-4 text-slate-500 font-mono text-xs">
                        <i class="far fa-clock mr-1 opacity-50"></i>6.0s — 9.0s
                    </td>
                    <td class="px-6 py-4 text-slate-600 font-medium">3.0s</td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2">
                            <div class="w-16 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                                <div class="h-full bg-rose-500" style="width: 98.50989724296076%"></div>
                            </div>
                            <span class="font-bold text-rose-600 text-xs">99%</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <button class="w-8 h-8 rounded-full bg-white border border-slate-200 text-slate-400 group-hover:bg-indigo-600 group-hover:text-white group-hover:border-indigo-600 transition-all shadow-sm">
                            <i class="fas fa-play text-[10px] pl-0.5"></i>
                        </button>
                    </td>
                </tr>
                
                <tr onclick="playVideo('event_clips/event_03_Velum_Critical.mp4', 'Critical - Velum')" class="hover-row-g0 transition-colors cursor-pointer group">
                    <td class="px-8 py-4">
                        <span class="badge badge-g0">Critical</span>
                    </td>
                    <td class="px-6 py-4 font-bold text-slate-700">Velum</td>
                    <td class="px-6 py-4 text-slate-500 font-mono text-xs">
                        <i class="far fa-clock mr-1 opacity-50"></i>13.0s — 15.0s
                    </td>
                    <td class="px-6 py-4 text-slate-600 font-medium">2.0s</td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2">
                            <div class="w-16 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                                <div class="h-full bg-rose-500" style="width: 94.77556287339853%"></div>
                            </div>
                            <span class="font-bold text-rose-600 text-xs">95%</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <button class="w-8 h-8 rounded-full bg-white border border-slate-200 text-slate-400 group-hover:bg-indigo-600 group-hover:text-white group-hover:border-indigo-600 transition-all shadow-sm">
                            <i class="fas fa-play text-[10px] pl-0.5"></i>
                        </button>
                    </td>
                </tr>
                
                <tr onclick="playVideo('event_clips/event_04_Velum_Critical.mp4', 'Critical - Velum')" class="hover-row-g0 transition-colors cursor-pointer group">
                    <td class="px-8 py-4">
                        <span class="badge badge-g0">Critical</span>
                    </td>
                    <td class="px-6 py-4 font-bold text-slate-700">Velum</td>
                    <td class="px-6 py-4 text-slate-500 font-mono text-xs">
                        <i class="far fa-clock mr-1 opacity-50"></i>19.0s — 21.0s
                    </td>
                    <td class="px-6 py-4 text-slate-600 font-medium">2.0s</td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2">
                            <div class="w-16 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                                <div class="h-full bg-rose-500" style="width: 91.20183001935598%"></div>
                            </div>
                            <span class="font-bold text-rose-600 text-xs">91%</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <button class="w-8 h-8 rounded-full bg-white border border-slate-200 text-slate-400 group-hover:bg-indigo-600 group-hover:text-white group-hover:border-indigo-600 transition-all shadow-sm">
                            <i class="fas fa-play text-[10px] pl-0.5"></i>
                        </button>
                    </td>
                </tr>
                
                    </tbody>
                </table>
            </div>
        </div>
        
        
        <button id="chatToggleBtn" onclick="toggleChat()" class="fixed bottom-8 right-8 w-14 h-14 bg-indigo-600 text-white rounded-full shadow-[0_8px_30px_rgb(79,70,229,0.4)] flex items-center justify-center hover:scale-110 hover:bg-indigo-700 transition-all z-50 group">
            <i class="fas fa-comment-medical text-xl group-hover:animate-pulse"></i>
        </button>

        <div id="chatWindow" class="fixed bottom-24 right-8 w-[380px] h-[600px] bg-white rounded-2xl shadow-2xl border border-slate-200 flex flex-col z-50 hidden origin-bottom-right">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-white rounded-t-2xl">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center text-white text-xs shadow-md">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div>
                        <h4 class="font-bold text-sm text-slate-800">AI Medical Assistant</h4>
                        <p class="text-[10px] text-green-500 font-bold flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-green-500"></span> Online</p>
                    </div>
                </div>
                <button onclick="toggleChat()" class="w-8 h-8 rounded-full hover:bg-slate-50 text-slate-400 flex items-center justify-center transition"><i class="fas fa-times"></i></button>
            </div>
            
            <div id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50/50">
                <div class="flex gap-3">
                    <div class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-robot text-indigo-500 text-xs"></i>
                    </div>
                    <div class="bg-white border border-slate-200 p-3 rounded-2xl rounded-tl-none text-sm text-slate-600 shadow-sm max-w-[85%]">
                        안녕하세요! 분석 결과에 대해 궁금한 점을 질문해주세요.
                    </div>
                </div>
            </div>
            
            <div class="p-4 bg-white border-t border-slate-100 rounded-b-2xl">
                <div class="flex gap-2 mb-3 overflow-x-auto no-scrollbar pb-1">
                    <button onclick="setQ('가장 심각한 이벤트 요약해줘')" class="whitespace-nowrap px-3 py-1.5 bg-indigo-50 text-indigo-700 text-xs font-bold rounded-full hover:bg-indigo-100 border border-indigo-100 transition">심각한 구간?</button>
                    <button onclick="setQ('치료 권고사항은?')" class="whitespace-nowrap px-3 py-1.5 bg-indigo-50 text-indigo-700 text-xs font-bold rounded-full hover:bg-indigo-100 border border-indigo-100 transition">치료 제안</button>
                    <button onclick="setQ('이벤트 횟수는 몇 번인가요?')" class="whitespace-nowrap px-3 py-1.5 bg-indigo-50 text-indigo-700 text-xs font-bold rounded-full hover:bg-indigo-100 border border-indigo-100 transition">이벤트 횟수</button>
                </div>
                <div class="relative">
                    <input type="text" id="vqaQuestion" class="w-full pl-4 pr-12 py-3 bg-slate-100 border-none rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 focus:bg-white transition-all outline-none" placeholder="Type your question..." onkeypress="if(event.key==='Enter') askAI()">
                    <button onclick="askAI()" class="absolute right-2 top-2 w-8 h-8 bg-indigo-600 text-white rounded-lg flex items-center justify-center hover:bg-indigo-700 shadow-sm transition">
                        <i class="fas fa-paper-plane text-xs"></i>
                    </button>
                </div>
            </div>
        </div>
        

        <div id="videoModal" class="fixed inset-0 z-[100] hidden" onclick="closeModal()">
            <div class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm transition-opacity"></div>
            <div class="fixed inset-0 flex items-center justify-center p-4">
                <div class="bg-black rounded-2xl overflow-hidden max-w-5xl w-full relative shadow-2xl border border-white/10" onclick="event.stopPropagation()">
                    <div class="bg-gradient-to-r from-slate-900 to-slate-800 px-6 py-4 flex justify-between items-center border-b border-white/10">
                        <h3 class="text-white font-bold flex items-center gap-2" id="modalTitle">
                            <i class="fas fa-play-circle text-indigo-400"></i> Event Replay
                        </h3>
                        <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-white/10 text-white hover:bg-white/20 flex items-center justify-center transition"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="aspect-video bg-black flex items-center justify-center">
                        <video id="player" controls class="w-full h-full"></video>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        const videoStem = "40091561_94_Velumclip";  // ✅ 이건 Python 변수니까 { 없이
        let history = [];
        let chatOpen = false;
        
        // typing indicator 스타일 추가
        (function() {
            const style = document.createElement('style');
            // f-string 이스케이프: CSS 중괄호는 두 개씩 { }
            style.textContent = `
                @keyframes blink {
                    0%, 100% { opacity: 0.2; }
                    50% { opacity: 1; }
                }
                .typing-dots span {
                    display: inline-block;
                    width: 6px;
                    height: 6px;
                    margin-right: 4px;
                    background: #0ea5e9;
                    border-radius: 9999px;
                    animation: blink 1s infinite;
                }
                .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
                .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
            `;
            document.head.appendChild(style);
        })();
        
        function toggleChat() {
            const win = document.getElementById('chatWindow');
            chatOpen = !chatOpen;
            if(chatOpen) {
                win.classList.remove('hidden');
                win.classList.add('chat-slide-enter');
                win.classList.remove('chat-slide-exit');
                setTimeout(() => document.getElementById('vqaQuestion').focus(), 300);
            } else {
                win.classList.add('chat-slide-exit');
                win.classList.remove('chat-slide-enter');
                setTimeout(() => win.classList.add('hidden'), 280);
            }
        }
        
        function setQ(text) { 
            const input = document.getElementById('vqaQuestion');
            input.value = text;
            input.focus();
        }
        
        async function askAI() {
            const input = document.getElementById('vqaQuestion');
            const q = input.value.trim();
            if(!q) return;
            
            const cont = document.getElementById('chatContainer');
            // User Message (pulse 제거)
            cont.innerHTML += `
                <div class="flex items-end gap-2 justify-end">
                    <div class="bg-indigo-600 text-white p-3 rounded-2xl rounded-tr-none text-sm max-w-[85%] shadow-md">
                        ${q}
                    </div>
                </div>`;
            
            input.value = '';
            input.disabled = true;
            cont.scrollTop = cont.scrollHeight;
            
            history.push({'role':'user', 'content':q});
            
            // 타이핑 인디케이터 추가
            const loadingId = "typing-" + Date.now();
            cont.innerHTML += `
                <div id="${loadingId}" class="flex items-start gap-3 mt-2">
                    <div class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center flex-shrink-0 shadow-sm">
                        <i class="fas fa-robot text-emerald-500 text-xs"></i>
                    </div>
                    <div class="bg-white border border-slate-200 p-3 rounded-2xl rounded-tl-none text-sm text-slate-700 shadow-sm max-w-[85%] leading-relaxed">
                        <div class="typing-dots flex items-center gap-1">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                </div>`;
            cont.scrollTop = cont.scrollHeight;
            
            try {
                const res = await fetch('/api/vqa', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({question:q, video_stem:videoStem, conversation_history:history.slice(0,-1)})
                });
                const data = await res.json();
                const ans = data.success ? data.answer : "Error: " + data.error;
                
                // 타이핑 인디케이터 제거
                const loadingEl = document.getElementById(loadingId);
                if(loadingEl) loadingEl.remove();
                
                // Bot Message
                cont.innerHTML += `
                    <div class="flex items-start gap-3 mt-2">
                        <div class="w-8 h-8 rounded-full bg-white border border-slate-200 flex items-center justify-center flex-shrink-0 shadow-sm">
                            <i class="fas fa-robot text-emerald-500 text-xs"></i>
                        </div>
                        <div class="bg-white border border-slate-200 p-3 rounded-2xl rounded-tl-none text-sm text-slate-700 shadow-sm max-w-[85%] leading-relaxed">
                            ${ans}
                        </div>
                    </div>`;
                    
                history.push({'role':'assistant', 'content':ans});
            } catch(e) {
                cont.innerHTML += `<div class="text-center my-2"><span class="bg-red-50 text-red-500 text-xs px-2 py-1 rounded">Network Error</span></div>`;
            } finally {
                input.disabled = false;
                input.focus();
                cont.scrollTop = cont.scrollHeight;
            }
        }
        
        function playVideo(src, title) {
            const m = document.getElementById('videoModal');
            const p = document.getElementById('player');
            const t = document.getElementById('modalTitle');
            
            p.src = src;
            t.innerHTML = `<i class="fas fa-play-circle text-indigo-400"></i> ${title}`;
            m.classList.remove('hidden');
            p.play();
        }
        
        function closeModal() {
            document.getElementById('videoModal').classList.add('hidden');
            const p = document.getElementById('player');
            p.pause();
            p.src = '';
        }
    </script>
</body>
</html>