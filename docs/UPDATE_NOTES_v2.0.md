# 📋 시스템 업데이트 내역 (v2.0)

**업데이트 날짜**: 2025-11-05  
**버전**: 2.0 (의료진 맞춤 판독 보조 시스템)

---

## 🆕 주요 업데이트 사항

### 1. ✅ 기준 이미지 시각화
- **기능**: 최대 기도 개방 상태 프레임을 보고서에 명시
- **표시 정보**:
  - 프레임 번호
  - ROI 면적 (px²)
  - 노란색 오버레이로 검출 영역 표시
- **목적**: 분석 기준을 명확하게 제시

### 2. ✅ 심각도 분류 기준 명시

보고서에 심각도 기준표 추가:

| 심각도 | 면적 감소율 | 임상적 의미 | 권장 조치 |
|--------|------------|------------|-----------|
| **Mild** | 30-50% | 경미한 기도 협착 | 경과 관찰 |
| **Moderate** | 50-70% | 중등도 기도 폐색 | 치료 고려 |
| **Severe** | 70-90% | 심각한 기도 폐색 | 적극적 치료 권장 |
| **Critical** | 90% 이상 | 거의 완전 폐색 | 즉시 치료 필요 |

### 3. ✅ 디버깅용 이미지 자동 생성

각 프레임마다 4가지 이미지 자동 저장:

```
frames/
├── frame_000001.jpg      # 원본 프레임 (전처리 후)
├── mask_000001.png       # 이진 마스크 (흰색 = ROI)
├── roi_crop_000001.jpg   # ROI만 크롭한 이미지
└── overlay_000001.jpg    # 원본 + 반투명 마스크 오버레이
```

**Overlay 이미지 특징**:
- 🟡 **노란색 영역**: 검출된 기도 개방 부분
- 🟢 **초록색 박스**: ROI Bounding Box
- 🔴 **빨간 점**: ROI 중심점

### 4. ✅ 인터랙티브 HTML 보고서

#### 클릭형 이벤트 테이블
- 각 폐색 이벤트 행을 클릭하면 해당 프레임 이미지를 모달로 표시
- **ESC** 키 또는 모달 외부 클릭으로 닫기
- 시간, 심각도, 감소율 정보와 함께 표시

#### 모달 이미지 정보
```javascript
// 클릭 시 표시되는 정보
시간: 0:00:05
심각도: Critical
감소율: 85.3%
```

### 5. ✅ 의료진 맞춤 UX

- **색상 코딩**: 심각도별 행 색상 구분
- **정렬**: 시간순 이벤트 정렬
- **접근성**: 큰 텍스트, 명확한 시각화
- **반응형**: 다양한 화면 크기 지원

---

## 🔧 수정된 파일

### 1. `video_analyzer.py`
```python
# 추가된 기능
- max_area_frame_index 추적
- mask, crop, overlay 이미지 자동 생성
- 이벤트에 이미지 경로 추가
- 중심점 및 bbox 시각화
```

### 2. `report_generator.py`
```python
# 추가된 기능
- generate_reference_image() 메소드
- 심각도 기준표 HTML 생성
- 인터랙티브 모달 JavaScript
- 클릭 이벤트 핸들러
```

---

## 📊 사용 예시

### 시나리오: Critical 이벤트 확인

1. **보고서 열기**
   ```
   report.html 파일을 웹 브라우저에서 열기
   ```

2. **이벤트 테이블 확인**
   - 빨간색 행: Critical 이벤트
   - 주황색 행: Severe 이벤트
   - 노란색 행: Moderate/Mild 이벤트

3. **이미지 확인**
   - Critical 이벤트 행 클릭
   - 모달 창에서 해당 프레임 이미지 확인
   - 노란색 영역으로 폐색 위치 파악

4. **디버깅 (필요시)**
   ```
   frames/
   ├── mask_000XXX.png     # 마스크 확인
   ├── roi_crop_000XXX.jpg # 크롭 영역 확인
   └── overlay_000XXX.jpg  # 오버레이 확인
   ```

---

## 🎯 의료진을 위한 팁

### 빠른 판독 워크플로우

1. **요약 확인** (5초)
   - 폐색 이벤트 총 개수
   - 최대 기도 개방 상태

2. **그래프 스캔** (10초)
   - 면적 변화 추이
   - 급격한 감소 구간

3. **Critical 이벤트 확인** (각 10초)
   - 빨간색 행 클릭
   - 이미지로 실제 폐색 확인

4. **종합 판단** (30초)
   - 빈도, 지속시간, 위치 종합
   - 치료 방침 결정

**총 소요 시간**: 약 2-3분 (이벤트 10개 기준)

---

## 🐛 트러블슈팅

### Q1: 이미지가 모달에서 안 보여요
**A**: 브라우저 콘솔 확인
```javascript
// 경로 문제일 가능성
frames/overlay_000001.jpg 파일이 존재하는지 확인
```

### Q2: Overlay 색상이 안 보여요
**A**: 마스크 검출 실패 가능성
```bash
# 디버깅: mask 이미지 확인
frames/mask_000XXX.png 열어보기
# 완전 검정색이면 ROI 검출 실패
```

### Q3: ROI가 너무 작게 검출돼요
**A**: Color-based 파라미터 조정
```python
# video_analyzer.py 수정
lower_dark = np.array([0, 0, 0])
upper_dark = np.array([180, 255, 100])  # V값 증가
```

---

## 📈 성능 지표

### 처리 속도
- **2초 비디오**: < 1초
- **30초 비디오**: ~ 5초 (예상)
- **5분 비디오**: ~ 30초 (예상)

### 메모리 사용
- **기본**: ~200MB
- **장시간 영상**: ~500MB

### 디스크 사용
```
비디오 1분당 생성되는 파일:
- 원본 프레임: ~5MB x 300개 = 1.5GB
- 마스크: ~100KB x 300개 = 30MB
- Overlay: ~5MB x 300개 = 1.5GB
- 총: 약 3GB
```

---

## 🔄 업데이트 적용 방법

### 기존 사용자

1. **파일 교체**
   ```bash
   # 백업
   cp video_analyzer.py video_analyzer.py.old
   cp report_generator.py report_generator.py.old
   
   # 새 파일로 교체
   # (제공된 파일 복사)
   ```

2. **의존성 확인**
   ```bash
   pip install --upgrade opencv-python numpy matplotlib
   ```

3. **테스트**
   ```bash
   python test_pipeline.py
   ```

### 새 사용자
```bash
# 전체 설치
pip install -r requirements.txt
python app.py
```

---

## 📚 관련 문서

- [README.md](README.md) - 전체 시스템 설명
- [DEMO_GUIDE.md](DEMO_GUIDE.md) - 시연 가이드
- [QUICK_START.txt](QUICK_START.txt) - 빠른 시작

---

## 🎊 다음 업데이트 예정

### v2.1 (예정)
- [ ] PDF 보고서 내보내기
- [ ] Velum/OTE 자동 분류 통합
- [ ] 배치 처리 UI
- [ ] 통계 분석 대시보드

### v3.0 (장기)
- [ ] 딥러닝 기반 ROI 검출
- [ ] 실시간 스트리밍 분석
- [ ] 클라우드 배포
- [ ] 모바일 앱

---

**업데이트 담당**: AI Medical Vision Team  
**문의**: 이슈 트래커 또는 이메일

---

## ✅ 체크리스트

배포 전 확인사항:

- [x] 기준 이미지 생성 확인
- [x] 심각도 기준표 표시 확인
- [x] 디버깅 이미지 (mask, crop, overlay) 생성 확인
- [x] HTML 모달 클릭 동작 확인
- [x] 색상 구분 (심각도별) 확인
- [x] 모바일 반응형 확인
- [x] 대용량 비디오 테스트 (예정)

---

**Happy Diagnosing! 🏥**
