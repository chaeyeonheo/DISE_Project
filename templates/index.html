<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DISE AI Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar-gradient { background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%); }
        .glass-panel { background: white; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex overflow-hidden">

    <aside class="w-64 sidebar-gradient text-white flex flex-col shadow-2xl z-20 hidden md:flex">
        <div class="h-20 flex items-center px-6 border-b border-slate-700/50">
            <div class="w-8 h-8 bg-indigo-500 rounded-lg flex items-center justify-center mr-3 shadow-lg shadow-indigo-500/30">
                <i class="fas fa-brain text-white text-sm"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg tracking-tight">DISE AI</h1>
                <p class="text-[10px] text-slate-400 uppercase tracking-wider font-medium">Medical Analytics</p>
            </div>
        </div>
        <nav class="flex-1 px-4 py-6 space-y-2">
            <div class="px-4 py-3 bg-indigo-600/20 text-indigo-300 rounded-xl border border-indigo-500/30 flex items-center gap-3">
                <i class="fas fa-upload w-5"></i> <span class="font-medium text-sm">Upload & Analyze</span>
            </div>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col relative overflow-hidden">
        <header class="h-20 px-8 flex items-center justify-between bg-white border-b border-slate-200">
            <h2 class="text-2xl font-bold text-slate-800">New Analysis</h2>
        </header>

        <div class="flex-1 overflow-auto px-8 pb-8">
            <div class="max-w-4xl mx-auto">
                
                <form id="uploadForm" class="space-y-8">
                    
                    <div class="bg-white rounded-3xl p-8 shadow-sm border border-slate-200">
                        <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-3">
                            <span class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-sm font-bold">1</span>
                            Upload Data
                        </h3>
                        <div id="dropZone" class="relative group cursor-pointer border-2 border-dashed border-slate-300 rounded-2xl p-12 text-center hover:border-indigo-500 hover:bg-indigo-50/30 transition-all duration-300">
                            <input type="file" id="fileInput" name="files" multiple accept=".mp4,.avi,.mov,.json" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" aria-label="Upload video or metadata">
                            <div class="w-16 h-16 bg-indigo-50 text-indigo-500 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                                <i class="fas fa-cloud-upload-alt text-3xl"></i>
                            </div>
                            <h4 class="text-lg font-bold text-slate-700">Drag & Drop files here</h4>
                            <p class="text-slate-500 text-sm mt-2">Video (.mp4) and Metadata (.json)</p>
                            <div id="fileList" class="mt-6 flex flex-wrap gap-2 justify-center"></div>
                        </div>
                        <div class="mt-4 flex justify-center">
                            <button type="button" id="selectFilesBtn" class="px-6 py-2 rounded-xl border border-slate-300 text-sm font-semibold text-slate-600 hover:border-indigo-500 hover:text-indigo-600 transition-all flex items-center gap-2">
                                <i class="fas fa-folder-open"></i> Select files
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl p-8 shadow-sm border border-slate-200">
                        <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-3">
                            <span class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-sm font-bold">2</span>
                            Analysis Options
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Extraction FPS</label>
                                <input type="number" name="fps_extract" value="5" min="1" max="30" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                                <p class="text-xs text-slate-400 mt-1">Higher = More accurate but slower</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Occlusion Threshold (%)</label>
                                <input type="number" name="threshold_percent" value="30" min="10" max="90" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                                <p class="text-xs text-slate-400 mt-1">Reduction % to trigger event</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Min Duration (sec)</label>
                                <input type="number" name="min_event_duration" value="1.0" min="0.1" step="0.1" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                                <p class="text-xs text-slate-400 mt-1">Minimum duration to valid event</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl p-8 shadow-sm border border-slate-200">
                        <h3 class="text-lg font-bold text-slate-800 mb-2 flex items-center gap-3">
                            <span class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-sm font-bold">3</span>
                            Reference Image (Optional)
                        </h3>
                        <p class="text-sm text-slate-500 mb-6 ml-11">
                            Upload normal breathing (maximum opening) reference image. <span class="text-indigo-600 font-medium">AI will auto-detect if not uploaded.</span>
                        </p>
                        <div class="ml-11">
                            <div id="refDropZone" class="relative group border-2 border-dashed border-slate-200 rounded-2xl p-8 text-center hover:border-emerald-500 hover:bg-emerald-50/30 transition-all duration-300">
                                <input type="file" name="reference_image" id="refInput" accept=".jpg,.jpeg,.png" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" aria-label="Upload reference image">
                                <div class="w-14 h-14 bg-emerald-50 text-emerald-500 rounded-2xl flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform">
                                    <i class="fas fa-image text-2xl"></i>
                                </div>
                                <h4 class="text-base font-semibold text-slate-700">Drag & Drop reference image</h4>
                                <p class="text-slate-500 text-sm mt-1">PNG / JPG (optional)</p>
                                <span id="refName" class="mt-4 inline-flex px-3 py-1.5 rounded-lg text-xs font-bold text-slate-400 border border-slate-200">Auto Mode Active</span>
                            </div>
                            <div class="mt-3">
                                <button type="button" id="selectRefBtn" class="px-4 py-2 rounded-xl border border-slate-300 text-sm font-semibold text-slate-600 hover:border-emerald-500 hover:text-emerald-600 transition-all flex items-center gap-2">
                                    <i class="fas fa-folder-open"></i> Select Image
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end pt-4">
                        <input type="file" name="video" id="realVideoInput" style="display:none;">
                        <input type="file" name="metadata" id="realJsonInput" style="display:none;">
                        
                        <button type="submit" id="submitBtn" disabled class="bg-slate-200 text-slate-400 px-10 py-4 rounded-2xl font-bold text-lg transition-all flex items-center gap-3 cursor-not-allowed shadow-none">
                            <span>Start AI Analysis</span>
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <div id="loadingOverlay" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="bg-white p-10 rounded-3xl shadow-2xl text-center max-w-sm mx-4 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 animate-pulse"></div>
            <div class="relative w-24 h-24 mx-auto mb-8">
                <div class="absolute inset-0 border-4 border-indigo-100 rounded-full"></div>
                <div class="absolute inset-0 border-4 border-indigo-600 rounded-full border-t-transparent animate-spin"></div>
                <div class="absolute inset-0 flex items-center justify-center"><i class="fas fa-brain text-3xl text-indigo-600"></i></div>
            </div>
            <h3 class="text-2xl font-bold text-slate-800 mb-2">Analyzing Video...</h3>
            <p class="text-slate-500 text-sm leading-relaxed">AI is analyzing your video precisely.<br><span class="text-xs text-slate-400">(This may take time depending on video length)</span></p>
        </div>
    </div>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const refInput = document.getElementById('refInput');
        const refDropZone = document.getElementById('refDropZone');
        const refName = document.getElementById('refName');
        const realVideoInput = document.getElementById('realVideoInput');
        const realJsonInput = document.getElementById('realJsonInput');
        const submitBtn = document.getElementById('submitBtn');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const selectFilesBtn = document.getElementById('selectFilesBtn');
        const selectRefBtn = document.getElementById('selectRefBtn');

        const updateRefBadge = () => {
            if (refInput.files.length) {
                refName.textContent = "ðŸ“¸ " + refInput.files[0].name;
                refName.className = 'inline-flex px-3 py-1.5 rounded-lg text-xs font-bold text-emerald-600 border border-emerald-200 bg-emerald-50';
            } else {
                refName.textContent = "Auto Mode Active";
                refName.className = 'inline-flex px-3 py-1.5 rounded-lg text-xs font-bold text-slate-400 border border-slate-200';
            }
        };
        refInput.onchange = updateRefBadge;

        const handleFiles = (files) => {
            fileList.innerHTML = '';
            Array.from(files).forEach(file => {
                const ext = file.name.split('.').pop().toLowerCase();
                let badgeClass = "bg-slate-100 text-slate-600 border-slate-200";
                let icon = "fa-file";

                if (['mp4', 'avi', 'mov', 'mkv'].includes(ext)) {
                    const dt = new DataTransfer(); dt.items.add(file); realVideoInput.files = dt.files;
                    badgeClass = "bg-indigo-50 text-indigo-600 border-indigo-100";
                    icon = "fa-video";
                } else if (ext === 'json') {
                    const dt = new DataTransfer(); dt.items.add(file); realJsonInput.files = dt.files;
                    badgeClass = "bg-emerald-50 text-emerald-600 border-emerald-100";
                    icon = "fa-code";
                }
                const badge = document.createElement('div');
                badge.className = `px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-2 border ${badgeClass}`;
                badge.innerHTML = `<i class="fas ${icon}"></i> ${file.name}`;
                fileList.appendChild(badge);
            });
            checkReady();
        };

        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('border-indigo-500', 'bg-indigo-50/10'); };
        dropZone.ondragleave = () => { dropZone.classList.remove('border-indigo-500', 'bg-indigo-50/10'); };
        dropZone.ondrop = (e) => { e.preventDefault(); dropZone.classList.remove('border-indigo-500', 'bg-indigo-50/10'); if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files); };
        dropZone.onclick = () => fileInput.click();
        selectFilesBtn.onclick = () => fileInput.click();
        fileInput.onchange = () => handleFiles(fileInput.files);

        refDropZone.ondragover = (e) => { e.preventDefault(); refDropZone.classList.add('border-emerald-500', 'bg-emerald-50/20'); };
        refDropZone.ondragleave = () => { refDropZone.classList.remove('border-emerald-500', 'bg-emerald-50/20'); };
        refDropZone.ondrop = (e) => {
            e.preventDefault();
            refDropZone.classList.remove('border-emerald-500', 'bg-emerald-50/20');
            if (e.dataTransfer.files.length) {
                const dt = new DataTransfer();
                Array.from(e.dataTransfer.files).forEach(file => dt.items.add(file));
                refInput.files = dt.files;
                updateRefBadge();
            }
        };
        selectRefBtn.onclick = () => refInput.click();

        function checkReady() {
            if (realVideoInput.files.length > 0) {
                submitBtn.disabled = false;
                submitBtn.className = "bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-10 py-4 rounded-2xl font-bold text-lg hover:shadow-lg hover:-translate-y-0.5 transition-all flex items-center gap-3 shadow-indigo-500/30";
            }
        }

        document.getElementById('uploadForm').onsubmit = async (e) => {
            e.preventDefault();
            if (!realVideoInput.files.length) return alert('Video file is required!');

            const formData = new FormData(document.getElementById('uploadForm'));
            formData.append('video', realVideoInput.files[0]);
            if (realJsonInput.files.length) formData.append('metadata', realJsonInput.files[0]);
            if (refInput.files.length) formData.append('reference_image', refInput.files[0]);

            loadingOverlay.classList.remove('hidden');

            try {
                const res = await fetch('/api/analyze', { method: 'POST', body: formData });
                const data = await res.json();
                if (data.success) window.location.href = data.report_url;
                else { alert('Error: ' + data.error); loadingOverlay.classList.add('hidden'); }
            } catch (err) {
                console.error(err); alert('Server Error'); loadingOverlay.classList.add('hidden');
            }
        };
    </script>
</body>
</html>
