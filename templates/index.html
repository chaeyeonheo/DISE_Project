<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DISE AI Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        
        /* Glassmorphism Utilities */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .glass-dark {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Animated Background Mesh */
        .bg-mesh {
            background-color: #f8fafc;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-size: 100% 600px;
            background-repeat: no-repeat;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Animation */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }
        .animate-float { animation: float 3s ease-in-out infinite; }
    </style>
</head>
<body class="bg-mesh text-slate-800 h-screen flex overflow-hidden selection:bg-indigo-500 selection:text-white">

    <aside class="w-20 lg:w-72 glass-dark text-white flex flex-col shadow-2xl z-20 transition-all duration-300 border-r border-slate-700/30">
        <div class="h-24 flex items-center px-0 lg:px-8 justify-center lg:justify-start border-b border-white/10">
            <div class="relative group">
                <div class="absolute -inset-1 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg blur opacity-40 group-hover:opacity-100 transition duration-200"></div>
                <div class="relative w-10 h-10 bg-slate-900 rounded-xl flex items-center justify-center border border-white/10">
                    <i class="fas fa-brain text-indigo-400 text-lg"></i>
                </div>
            </div>
            <div class="hidden lg:block ml-4">
                <h1 class="font-bold text-xl tracking-tight text-white">DISE AI</h1>
                <p class="text-[10px] text-slate-400 font-medium tracking-widest uppercase">Medical Analytics</p>
            </div>
        </div>

        <nav class="flex-1 py-8 px-4 space-y-2">
            <div class="px-4 py-4 bg-gradient-to-r from-indigo-600/20 to-purple-600/20 text-indigo-300 rounded-2xl border border-indigo-500/30 flex items-center justify-center lg:justify-start gap-4 transition-all hover:border-indigo-500/50 cursor-pointer shadow-lg shadow-indigo-900/20">
                <i class="fas fa-microscope text-lg"></i> 
                <span class="font-semibold text-sm hidden lg:block">New Analysis</span>
            </div>
            
            <div class="mt-8 px-6 hidden lg:block">
                <p class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-4">System Status</p>
                <div class="flex items-center gap-3 text-sm text-slate-300 mb-2">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]"></span>
                    AI Model Ready
                </div>
                <div class="flex items-center gap-3 text-sm text-slate-300">
                    <span class="w-2 h-2 rounded-full bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,0.5)]"></span>
                    Server Active
                </div>
            </div>
        </nav>

        <div class="p-4 border-t border-white/10">
            <div class="flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 transition-colors cursor-pointer">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 border border-white/10 flex items-center justify-center">
                    <i class="fas fa-user-doctor text-slate-300 text-sm"></i>
                </div>
                <div class="hidden lg:block">
                    <p class="text-sm font-semibold text-white">Dr. User</p>
                    <p class="text-xs text-slate-400">AI Convergence</p>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative overflow-hidden bg-slate-50/50">
        <header class="h-20 px-8 flex items-center justify-between glass sticky top-0 z-10">
            <div>
                <h2 class="text-2xl font-bold text-slate-800">Upload & Analyze</h2>
                <p class="text-xs text-slate-500 mt-1">AI-powered Endoscopy Video Analysis Pipeline</p>
            </div>
            <div class="flex items-center gap-4">
                <button class="w-10 h-10 rounded-full glass flex items-center justify-center text-slate-500 hover:text-indigo-600 hover:bg-white transition-all">
                    <i class="fas fa-bell"></i>
                </button>
                <button class="w-10 h-10 rounded-full glass flex items-center justify-center text-slate-500 hover:text-indigo-600 hover:bg-white transition-all">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-auto p-4 lg:p-8">
            <div class="max-w-6xl mx-auto">
                <form id="uploadForm" class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                    
                    <div class="lg:col-span-8 flex flex-col gap-6">
                        <div class="glass rounded-3xl p-1 shadow-sm transition-all hover:shadow-md">
                            <div class="bg-white/50 rounded-[20px] p-6 lg:p-8 border border-white/60">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center text-sm font-bold shadow-sm">1</div>
                                        Video Data
                                    </h3>
                                    <span class="text-xs font-semibold text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full border border-indigo-100">Required</span>
                                </div>

                                <div id="dropZone" class="relative group cursor-pointer border-2 border-dashed border-slate-300 rounded-2xl p-10 text-center hover:border-indigo-500 hover:bg-indigo-50/30 transition-all duration-300 bg-slate-50/50">
                                    <input type="file" id="fileInput" name="files" multiple accept=".mp4,.avi,.mov,.json" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" aria-label="Upload video or metadata">
                                    
                                    <div class="w-16 h-16 bg-white text-indigo-500 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-sm group-hover:scale-110 group-hover:shadow-indigo-200/50 transition-all duration-300 border border-slate-100">
                                        <i class="fas fa-cloud-upload-alt text-3xl"></i>
                                    </div>
                                    <h4 class="text-lg font-bold text-slate-700 group-hover:text-indigo-700 transition-colors">Drag & Drop files here</h4>
                                    <p class="text-slate-500 text-sm mt-2">Supports MP4, AVI, MOV & JSON Metadata</p>
                                    
                                    <div id="fileList" class="mt-6 flex flex-wrap gap-2 justify-center min-h-[20px]"></div>
                                </div>
                                <div class="mt-4 flex justify-center">
                                    <button type="button" id="selectFilesBtn" class="px-6 py-2.5 rounded-xl bg-white border border-slate-200 text-sm font-semibold text-slate-600 hover:border-indigo-500 hover:text-indigo-600 hover:shadow-md transition-all flex items-center gap-2">
                                        <i class="fas fa-folder-open"></i> Browse Files
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="glass rounded-3xl p-1 shadow-sm transition-all hover:shadow-md">
                            <div class="bg-white/50 rounded-[20px] p-6 border border-white/60">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-lg bg-emerald-100 text-emerald-600 flex items-center justify-center text-sm font-bold shadow-sm">3</div>
                                        Reference Image
                                    </h3>
                                    <span class="text-xs font-semibold text-emerald-600 bg-emerald-50 px-3 py-1 rounded-full border border-emerald-100">Auto-Detect if Empty</span>
                                </div>

                                <div class="flex gap-4 items-start">
                                    <div class="flex-1">
                                        <div id="refDropZone" class="relative group border-2 border-dashed border-slate-200 rounded-2xl p-6 text-center hover:border-emerald-500 hover:bg-emerald-50/30 transition-all duration-300 bg-slate-50/30">
                                            <input type="file" name="reference_image" id="refInput" accept=".jpg,.jpeg,.png" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                                            
                                            <div class="flex items-center justify-center gap-4">
                                                <div class="w-12 h-12 bg-emerald-50 text-emerald-500 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                                                    <i class="fas fa-image text-xl"></i>
                                                </div>
                                                <div class="text-left">
                                                    <h4 class="text-sm font-bold text-slate-700">Upload Reference (Normal State)</h4>
                                                    <p class="text-slate-400 text-xs mt-0.5">PNG / JPG Max Breathing</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex flex-col gap-2 justify-center h-full pt-2">
                                        <button type="button" id="selectRefBtn" class="h-12 px-4 rounded-xl border border-slate-200 bg-white text-slate-500 hover:border-emerald-500 hover:text-emerald-600 transition-all">
                                            <i class="fas fa-folder-open"></i>
                                        </button>
                                        <div id="refName" class="px-3 py-1.5 rounded-lg text-[10px] font-bold text-slate-400 border border-slate-200 bg-slate-50 text-center whitespace-nowrap">
                                            Auto Mode
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-4 flex flex-col gap-6">
                        
                        <div class="glass rounded-3xl p-1 shadow-sm h-full">
                            <div class="bg-white/60 rounded-[20px] p-6 border border-white/60 h-full flex flex-col">
                                <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center text-sm font-bold shadow-sm">2</div>
                                    Analysis Config
                                </h3>
                                
                                <div class="space-y-5 flex-1">
                                    <div class="group">
                                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 ml-1">Extraction FPS</label>
                                        <div class="relative">
                                            <input type="number" name="fps_extract" value="1" min="1" max="30" class="w-full pl-4 pr-4 py-3 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all text-slate-700 font-semibold shadow-sm">
                                            <span class="absolute right-4 top-3.5 text-xs text-slate-400 font-medium">frames/sec</span>
                                        </div>
                                        <p class="text-[10px] text-slate-400 mt-1.5 ml-1 group-hover:text-indigo-500 transition-colors">Higher = More accurate but slower</p>
                                    </div>

                                    <div class="group">
                                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 ml-1">Occlusion Threshold</label>
                                        <div class="relative">
                                            <input type="number" name="threshold_percent" value="30" min="10" max="90" class="w-full pl-4 pr-4 py-3 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all text-slate-700 font-semibold shadow-sm">
                                            <span class="absolute right-4 top-3.5 text-xs text-slate-400 font-medium">% reduction</span>
                                        </div>
                                        <div class="mt-1.5 ml-1 space-y-0.5">
                                            <p class="text-[10px] text-indigo-500 font-medium">‚Ä¢ Normal (<50%) </p>
                                            <p class="text-[10px] text-indigo-500 font-medium">‚Ä¢ Partial (50-75%) </p>
                                            <p class="text-[10px] text-indigo-500 font-medium">‚Ä¢ Complete (>75%) </p>
                                        </div>
                                    </div>

                                    <div class="group">
                                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 ml-1">Min Duration</label>
                                        <div class="relative">
                                            <input type="number" name="min_event_duration" value="1.0" min="0.1" step="0.1" class="w-full pl-4 pr-4 py-3 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all text-slate-700 font-semibold shadow-sm">
                                            <span class="absolute right-4 top-3.5 text-xs text-slate-400 font-medium">seconds</span>
                                        </div>
                                        <p class="text-[10px] text-indigo-500 font-medium mt-1.5 ml-1">‚Ä¢ Standard: 5~10s+ (ÏµúÏÜå 5Ï¥à Ïù¥ÏÉÅ)</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-auto pt-2">
                            <input type="file" name="video" id="realVideoInput" style="display:none;">
                            <input type="file" name="metadata" id="realJsonInput" style="display:none;">
                            
                            <button type="submit" id="submitBtn" disabled class="w-full bg-slate-200 text-slate-400 py-4 rounded-2xl font-bold text-lg transition-all flex items-center justify-center gap-3 cursor-not-allowed shadow-none group">
                                <span>Start AI Analysis</span>
                                <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                            </button>
                        </div>

                    </div>
                </form>
            </div>
        </div>
    </main>

    <div id="loadingOverlay" class="fixed inset-0 bg-slate-900/90 backdrop-blur-md z-50 hidden flex items-center justify-center">
        <div class="bg-white/10 border border-white/20 p-10 rounded-3xl shadow-2xl text-center max-w-sm mx-4 relative overflow-hidden backdrop-blur-xl">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 animate-pulse"></div>
            
            <div class="relative w-28 h-28 mx-auto mb-8">
                <div class="absolute inset-0 border-4 border-indigo-500/30 rounded-full animate-pulse"></div>
                <div class="absolute inset-0 border-4 border-indigo-400 rounded-full border-t-transparent animate-spin"></div>
                <div class="absolute inset-0 flex items-center justify-center animate-float">
                    <i class="fas fa-brain text-4xl text-white drop-shadow-[0_0_15px_rgba(99,102,241,0.5)]"></i>
                </div>
            </div>
            
            <h3 class="text-2xl font-bold text-white mb-3">Processing Video</h3>
            <p class="text-indigo-200 text-sm leading-relaxed font-light">
                Our AI model is analyzing airway obstruction patterns.<br>
                <span class="text-xs text-slate-400 mt-2 block opacity-70">Please do not close this window.</span>
            </p>
        </div>
    </div>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const refInput = document.getElementById('refInput');
        const refDropZone = document.getElementById('refDropZone');
        const refName = document.getElementById('refName');
        const realVideoInput = document.getElementById('realVideoInput');
        const realJsonInput = document.getElementById('realJsonInput');
        const submitBtn = document.getElementById('submitBtn');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const selectFilesBtn = document.getElementById('selectFilesBtn');
        const selectRefBtn = document.getElementById('selectRefBtn');

        const updateRefBadge = () => {
            if (refInput.files.length) {
                refName.textContent = "üì∏ " + refInput.files[0].name;
                refName.className = 'px-3 py-1.5 rounded-lg text-[10px] font-bold text-emerald-600 border border-emerald-200 bg-emerald-50 text-center whitespace-nowrap';
            } else {
                refName.textContent = "Auto Mode";
                refName.className = 'px-3 py-1.5 rounded-lg text-[10px] font-bold text-slate-400 border border-slate-200 bg-slate-50 text-center whitespace-nowrap';
            }
        };
        refInput.onchange = updateRefBadge;

        const handleFiles = (files) => {
            fileList.innerHTML = '';
            Array.from(files).forEach(file => {
                const ext = file.name.split('.').pop().toLowerCase();
                let badgeClass = "bg-slate-100 text-slate-600 border-slate-200";
                let icon = "fa-file";

                if (['mp4', 'avi', 'mov', 'mkv'].includes(ext)) {
                    const dt = new DataTransfer(); dt.items.add(file); realVideoInput.files = dt.files;
                    badgeClass = "bg-indigo-50 text-indigo-700 border-indigo-100 ring-1 ring-indigo-500/20";
                    icon = "fa-video";
                } else if (ext === 'json') {
                    const dt = new DataTransfer(); dt.items.add(file); realJsonInput.files = dt.files;
                    badgeClass = "bg-emerald-50 text-emerald-700 border-emerald-100 ring-1 ring-emerald-500/20";
                    icon = "fa-code";
                }
                const badge = document.createElement('div');
                badge.className = `px-3 py-2 rounded-xl text-xs font-bold flex items-center gap-2 border shadow-sm transition-all hover:scale-105 ${badgeClass}`;
                badge.innerHTML = `<i class="fas ${icon}"></i> ${file.name}`;
                fileList.appendChild(badge);
            });
            checkReady();
        };

        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('border-indigo-500', 'bg-indigo-50/50', 'scale-[1.02]'); };
        dropZone.ondragleave = () => { dropZone.classList.remove('border-indigo-500', 'bg-indigo-50/50', 'scale-[1.02]'); };
        dropZone.ondrop = (e) => { 
            e.preventDefault(); 
            dropZone.classList.remove('border-indigo-500', 'bg-indigo-50/50', 'scale-[1.02]'); 
            if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files); 
        };
        dropZone.onclick = () => fileInput.click();
        selectFilesBtn.onclick = (e) => { e.stopPropagation(); fileInput.click(); }; // prevent bubbling
        fileInput.onchange = () => handleFiles(fileInput.files);

        refDropZone.ondragover = (e) => { e.preventDefault(); refDropZone.classList.add('border-emerald-500', 'bg-emerald-50/40'); };
        refDropZone.ondragleave = () => { refDropZone.classList.remove('border-emerald-500', 'bg-emerald-50/40'); };
        refDropZone.ondrop = (e) => {
            e.preventDefault();
            refDropZone.classList.remove('border-emerald-500', 'bg-emerald-50/40');
            if (e.dataTransfer.files.length) {
                const dt = new DataTransfer();
                Array.from(e.dataTransfer.files).forEach(file => dt.items.add(file));
                refInput.files = dt.files;
                updateRefBadge();
            }
        };
        selectRefBtn.onclick = () => refInput.click();

        function checkReady() {
            if (realVideoInput.files.length > 0) {
                submitBtn.disabled = false;
                submitBtn.className = "w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-2xl font-bold text-lg hover:shadow-xl hover:shadow-indigo-500/30 hover:-translate-y-0.5 transition-all flex items-center justify-center gap-3 cursor-pointer group";
            }
        }

        document.getElementById('uploadForm').onsubmit = async (e) => {
            e.preventDefault();
            if (!realVideoInput.files.length) return alert('Video file is required!');

            const formData = new FormData(document.getElementById('uploadForm'));
            formData.append('video', realVideoInput.files[0]);
            if (realJsonInput.files.length) formData.append('metadata', realJsonInput.files[0]);
            if (refInput.files.length) formData.append('reference_image', refInput.files[0]);

            loadingOverlay.classList.remove('hidden');

            try {
                const res = await fetch('/api/analyze', { method: 'POST', body: formData });
                const data = await res.json();
                if (data.success) window.location.href = data.report_url;
                else { alert('Error: ' + data.error); loadingOverlay.classList.add('hidden'); }
            } catch (err) {
                console.error(err); alert('Server Error'); loadingOverlay.classList.add('hidden');
            }
        };
    </script>
</body>
</html>