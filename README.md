# ìˆ˜ë©´ ë‚´ì‹œê²½ ê¸°ë„ íìƒ‰ ìë™ ë¶„ì„ + VQA ì‹œìŠ¤í…œ
## Sleep Endoscopy Airway Occlusion & VQA Analysis System

**ë²„ì „**: 2.0  
**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-11-05

---

## ğŸ“‹ ì‹œìŠ¤í…œ ê°œìš”

ìˆ˜ë©´ ë‚´ì‹œê²½(DISE) ë¹„ë””ì˜¤ì—ì„œ ê¸°ë„ íìƒ‰ì„ ìë™ìœ¼ë¡œ ê°ì§€Â·ë¶„ì„í•˜ê³ ,  
ë¶„ì„ ê²°ê³¼ë¥¼ ê¸°ë°˜ìœ¼ë¡œ **ìì—°ì–´ ì§ˆì˜ì‘ë‹µ(VQA, Vision Question Answering)**ê¹Œì§€ ì§€ì›í•˜ëŠ” ì›¹ ê¸°ë°˜ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

### ì£¼ìš” ê¸°ëŠ¥

- âœ… **OTE/Velum ìë™ ë¶„ë¥˜**: ë”¥ëŸ¬ë‹ ê¸°ë°˜ í”„ë ˆì„ë³„ OTE / Velum / None ë¶„ë¥˜  
- âœ… **ìë™ ì „ì²˜ë¦¬**: ê²€ì • ë°°ê²½ ì œê±° ë° ROI ì¶”ì¶œ  
- âœ… **Color-based íìƒ‰ ê²€ì¶œ**: HSV ìƒ‰ê³µê°„ ê¸°ë°˜ ê¸°ë„ ê°œë°© ì˜ì—­ ìë™ ì¶”ì¶œ  
- âœ… **ì‹œê³„ì—´ ë¶„ì„**: í”„ë ˆì„ë³„ ë©´ì  ë³€í™” ì¶”ì  ë° íìƒ‰ ì´ë²¤íŠ¸ ê°ì§€  
- âœ… **ë³´ê³ ì„œ ìƒì„±**: HTML/JSON í˜•ì‹ì˜ ìƒì„¸ ë¶„ì„ ë³´ê³ ì„œ  
- âœ… **ì›¹ UI**: ì§ê´€ì ì¸ ì—…ë¡œë“œ ë° ë¶„ì„ ì¸í„°í˜ì´ìŠ¤  
- âœ… **VQA(ì§ˆì˜ì‘ë‹µ)**: ë¶„ì„ ê²°ê³¼ì— ëŒ€í•´ ì˜ì‚¬ê°€ ìì—°ì–´ë¡œ ì§ˆë¬¸í•˜ë©´, LLMì´ ì˜ë£Œ ì „ë¬¸ê°€ ê´€ì ì—ì„œ ë‹µë³€  

---

## ğŸš€ ë¹ ë¥¸ ì‹œì‘

### 1. í•„ìˆ˜ ìš”êµ¬ì‚¬í•­

- Python 3.8 ì´ìƒ
- PyTorch (Classification ëª¨ë¸ìš©)
- OpenCV
- Flask
- NumPy, Matplotlib

### 2. ì„¤ì¹˜

```bash
# 1. í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
pip install -r requirements.txt

# 2. í†µí•© ì›¹ ì„œë²„ ì‹¤í–‰
python integrated_app.py

# (ì„ íƒ) ê¸°ì¡´ ë‹¨ì¼ ì•±
python app.py
```

### 3. ê¸°ë³¸ ì‚¬ìš©ë²•

1. ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ `http://localhost:5000` ì ‘ì†  
2. ìˆ˜ë©´ ë‚´ì‹œê²½ ë¹„ë””ì˜¤ ì—…ë¡œë“œ (.mp4, .avi, .mov, .mkv)  
3. ë¶„ì„ ì˜µì…˜ ì„¤ì • (FPS, Threshold ë“±)  
4. "Start AI Analysis" í´ë¦­  
5. ì™„ë£Œ í›„ ìƒì„¸ HTML ë³´ê³ ì„œì—ì„œ ê²°ê³¼ í™•ì¸  

---

## ğŸ“‚ í”„ë¡œì íŠ¸ êµ¬ì¡°

```text
DISE_Project/
â”‚
â”œâ”€â”€ integrated_app.py              # í†µí•© ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ (ê¶Œì¥)
â”œâ”€â”€ integrated_analyzer.py         # í†µí•© ë¶„ì„ ì—”ì§„
â”œâ”€â”€ integrated_report_generator.py # í†µí•© ë³´ê³ ì„œ + VQA ìƒì„±
â”‚
â”œâ”€â”€ app.py                         # ê¸°ì¡´ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜
â”œâ”€â”€ video_analyzer.py              # ROI ê²€ì¶œ & íìƒ‰ ë¶„ì„
â”œâ”€â”€ report_generator.py            # ê¸°ì¡´ ë³´ê³ ì„œ ìƒì„±
â”‚
â”œâ”€â”€ ote_velum_classification_final/  # Classification ëª¨ë¸
â”‚   â”œâ”€â”€ train.py                   # ëª¨ë¸ í•™ìŠµ
â”‚   â”œâ”€â”€ inference.py               # ì¶”ë¡ 
â”‚   â””â”€â”€ checkpoints/               # í•™ìŠµëœ ëª¨ë¸(best_model.pth ë“±)
â”‚
â”œâ”€â”€ docs/                          # ğŸ“š ë¬¸ì„œ
â”‚   â”œâ”€â”€ INTEGRATED_GUIDE.md       # í†µí•© ì‹œìŠ¤í…œ ê°€ì´ë“œ
â”‚   â”œâ”€â”€ UPDATE_NOTES_v2.0.md      # ìµœì‹  ì—…ë°ì´íŠ¸ ë‚´ì—­
â”‚   â””â”€â”€ archive/                   # ì•„ì¹´ì´ë¸Œ ë¬¸ì„œ
â”‚
â”œâ”€â”€ templates/                     # ì›¹ UI í…œí”Œë¦¿
â”œâ”€â”€ uploads/                       # ì—…ë¡œë“œëœ ë¹„ë””ì˜¤
â””â”€â”€ outputs/                       # ë¶„ì„ ê²°ê³¼ (report.html, analysis_results.json ë“±)
```

---

## ğŸ”¬ í•µì‹¬ ê¸°ìˆ 

### 1. Classification ëª¨ë¸

- ResNet-50 ê¸°ë°˜ OTE / Velum / None í”„ë ˆì„ ë¶„ë¥˜  
- `ote_velum_classification_final/` í•˜ìœ„ì—ì„œ í•™ìŠµ ë° ì¶”ë¡  ìˆ˜í–‰  

### 2. ROI ê²€ì¶œ & íìƒ‰ ë¶„ì„

- `video_analyzer.py`ì˜ HSV ìƒ‰ê³µê°„ ê¸°ë°˜ ROI ê²€ì¶œ  
- ê¸°ì¤€ ëŒ€ë¹„ ê¸°ë„ ë©´ì  ê°ì†Œìœ¨ë¡œ íìƒ‰ ì´ë²¤íŠ¸ ê°ì§€  
- ì´ë²¤íŠ¸ë³„ ì‹¬ê°ë„(Mild / Moderate / Severe / Critical) ë¶„ë¥˜  

### 3. í†µí•© ë¶„ì„ íŒŒì´í”„ë¼ì¸

- `integrated_analyzer.py`  
  - í”„ë ˆì„ ì¶”ì¶œ, OTE/Velum ë¶„ë¥˜, ROI ë¶„ì„, ì´ë²¤íŠ¸ ê°ì§€  
  - ìµœì¢… ê²°ê³¼ë¥¼ `analysis_results.json`ìœ¼ë¡œ ì €ì¥  

### 4. LLM ê¸°ë°˜ ë³´ê³ ì„œ & VQA

- `integrated_report_generator.py`  
  - `build_analysis_context()`  
    - `analysis_results.json`ì„ LLMì´ ì´í•´í•  ìˆ˜ ìˆëŠ” í…ìŠ¤íŠ¸ ì»¨í…ìŠ¤íŠ¸ë¡œ ë³€í™˜  
  - `generate_report()`  
    - ë¶„ì„ ìš”ì•½, ì°¨íŠ¸, ì´ë²¤íŠ¸ ëª©ë¡ ë“±ì„ í¬í•¨í•œ HTML ë³´ê³ ì„œ ìƒì„±  
  - `answer_question(question)`  
    - `[ë°ì´í„° ì»¨í…ìŠ¤íŠ¸ + ì‚¬ìš©ì ì§ˆë¬¸]`ì„ LLMì— ì „ë‹¬í•˜ì—¬ ìì—°ì–´ ë‹µë³€ ìƒì„±  

---

## ğŸ“Š ì¶œë ¥ ê²°ê³¼

ê° ë¶„ì„ë§ˆë‹¤ `outputs/{video_stem}/` ë””ë ‰í† ë¦¬ì— ë‹¤ìŒ íŒŒì¼ë“¤ì´ ìƒì„±ë©ë‹ˆë‹¤:

- `report.html`  
  - í™˜ì ì •ë³´, íƒ€ì„ë¼ì¸, ì‹¬ê°ë„ ì°¨íŠ¸, ì´ë²¤íŠ¸ ëª©ë¡, **VQA UI** í¬í•¨
- `analysis_results.json`  
  - í”„ë ˆì„ë³„ ë¶„ë¥˜, Segment ì •ë³´, íìƒ‰ ì´ë²¤íŠ¸ ë“± ì›ë³¸ ë¶„ì„ ë°ì´í„°
- `timeline.png` / `severity_chart.png` ë“± ì‹œê°í™” ê²°ê³¼
- `event_clips/`  
  - ìœ„í—˜ êµ¬ê°„ ë¹„ë””ì˜¤ í´ë¦½

---

## âš™ï¸ ì£¼ìš” ì„¤ì • íŒŒë¼ë¯¸í„°

### í”„ë ˆì„ ì¶”ì¶œ ë¹ˆë„ (FPS)

- **ê¸°ë³¸ê°’**: 5  
- **ê¶Œì¥ ë²”ìœ„**: 1â€“10  
- ë†’ì„ìˆ˜ë¡ ì •ë°€í•˜ì§€ë§Œ ì²˜ë¦¬ ì‹œê°„ ì¦ê°€

### íìƒ‰ ê¸°ì¤€ (Threshold %)

- **ê¸°ë³¸ê°’**: 30%  
- **ê¶Œì¥ ë²”ìœ„**: 20â€“50%  
- ë‚®ì„ìˆ˜ë¡ ë¯¼ê°í•˜ê²Œ ê°ì§€

---

## ğŸ§  VQA(Vision Question Answering) ê¸°ëŠ¥

### 1. ê°œë…

**Vision Question Answering**:  
ì˜ë£Œ ì˜ìƒ ë¶„ì„ ê²°ê³¼ì— ëŒ€í•´ **ìì—°ì–´ë¡œ ì§ˆë¬¸**í•˜ë©´,  
AIê°€ **ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì„ìƒì  í•´ì„**ì„ í¬í•¨í•´ ë‹µë³€í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

#### ì˜ˆì‹œ

```text
ğŸ‘¨â€âš•ï¸ ì§ˆë¬¸: "ê°€ì¥ ì‹¬ê°í•œ íìƒ‰ ì´ë²¤íŠ¸ëŠ” ì–¸ì œ ë°œìƒí–ˆë‚˜ìš”?"

ğŸ¤– AI ë‹µë³€: "ê°€ì¥ ì‹¬ê°í•œ íìƒ‰ ì´ë²¤íŠ¸ëŠ” 12.5ì´ˆì—ì„œ 15.2ì´ˆ ì‚¬ì´ì—
OTE ë¶€ìœ„ì—ì„œ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì´ ì´ë²¤íŠ¸ëŠ” Severe ë“±ê¸‰ìœ¼ë¡œ ë¶„ë¥˜ë˜ì—ˆìœ¼ë©°,
ìµœëŒ€ ê¸°ë„ ë©´ì  ëŒ€ë¹„ 65.3%ì˜ ê°ì†Œë¥¼ ë³´ì˜€ìŠµë‹ˆë‹¤.
ì´ëŠ” ìƒê¸°ë„ íì‡„ì˜ ëª…í™•í•œ ì¦ê±°ë¡œ, ìˆ˜ìˆ ì  ì¹˜ë£Œë¥¼ ê³ ë ¤í•´ì•¼ í•  ìˆ˜ì¤€ì…ë‹ˆë‹¤."
```

---

### 2. VQA íë¦„ ìš”ì•½

1. `/api/analyze`  
   - ë¹„ë””ì˜¤ ì—…ë¡œë“œ â†’ `IntegratedDISEAnalyzer`ê°€ ë¶„ì„ â†’ `analysis_results.json` ìƒì„±  
   - `IntegratedReportGenerator.generate_report()`ê°€ HTML ë³´ê³ ì„œ ìƒì„± (VQA UI í¬í•¨)
2. ì‚¬ìš©ìê°€ ë³´ê³ ì„œ í˜ì´ì§€ í•˜ë‹¨ VQA ì„¹ì…˜ì—ì„œ ì§ˆë¬¸ ì…ë ¥
3. `/api/vqa` (POST)  
   - `{ "question": "...", "video_stem": "..." }`  
   - ì„œë²„ì—ì„œ `analysis_results.json` ë¡œë“œ â†’ `build_analysis_context()` â†’ LLM í˜¸ì¶œ
4. LLM(Gemini ë“±)ì´ ë°ì´í„° ê¸°ë°˜ ë‹µë³€ ìƒì„±
5. ë¸Œë¼ìš°ì € UIì— ë‹µë³€ í‘œì‹œ (Markdown ìŠ¤íƒ€ì¼)

---

### 3. í•µì‹¬ ì½”ë“œ ê°œë… (ìš”ì•½)

```python
# integrated_report_generator.py

def build_analysis_context(self):
    """ë¶„ì„ ê²°ê³¼ â†’ LLMì´ ì´í•´í•˜ëŠ” í…ìŠ¤íŠ¸"""
    # í™˜ì ì •ë³´, ì˜ìƒ ì •ë³´, ë¶€ìœ„ë³„ ìµœëŒ€ ë©´ì , ì´ë²¤íŠ¸ ë¦¬ìŠ¤íŠ¸ ë“±ì„ í…ìŠ¤íŠ¸ë¡œ ìš”ì•½
    ...

def answer_question(self, question: str) -> str:
    context = self.build_analysis_context()
    prompt = f"""
    [ì—­í• ] ìˆ˜ë©´ ë¬´í˜¸í¡ì¦ ì§„ë‹¨ ì „ë¬¸ì˜

    [ë°ì´í„°]
    {context}

    [ì§ˆë¬¸]
    {question}

    [ë‹µë³€ ì§€ì¹¨]
    1. ì˜ë£Œ ì „ë¬¸ê°€ ê´€ì 
    2. ë°ì´í„°ì— ê·¼ê±°
    3. ì„ìƒì  ì˜ë¯¸ í¬í•¨
    4. í•œêµ­ì–´ ë‹µë³€
    """
    # Gemini ë“± LLM API í˜¸ì¶œ
    ...
    return answer
```

```python
# integrated_app.py (ì˜ˆì‹œ)

@app.route('/api/vqa', methods=['POST'])
def vqa():
    data = request.get_json()
    question = data['question']
    video_stem = data['video_stem']

    # outputs/{video_stem}/analysis_results.json ë¡œë“œ
    results_path = app.config['OUTPUT_FOLDER'] / video_stem / 'analysis_results.json'
    results = json.load(open(results_path, 'r', encoding='utf-8'))

    # VQA í˜¸ì¶œ
    gen = IntegratedReportGenerator(results, api_key=app.config['GEMINI_API_KEY'])
    answer = gen.answer_question(question)

    return jsonify({'success': True, 'answer': answer})
```

---

### 4. VQA UI ê°œìš”

ë³´ê³ ì„œ HTML(`report.html`) í•˜ë‹¨ì— ë‹¤ìŒê³¼ ê°™ì€ VQA ì„¹ì…˜ì´ í¬í•¨ë©ë‹ˆë‹¤:

- ì§ˆë¬¸ ì…ë ¥ì°½
- "ì§ˆë¬¸í•˜ê¸°" ë²„íŠ¼
- ë¡œë”© ì¸ë””ì¼€ì´í„°
- AI ë‹µë³€ ì˜ì—­
- ìì£¼ ì“°ëŠ” ì§ˆë¬¸ ì˜ˆì‹œ ë²„íŠ¼ (í´ë¦­ ì‹œ ìë™ ì…ë ¥)

UI ì˜ˆì‹œëŠ” `README_vqa.md`ì˜ ASCII ë‹¤ì´ì–´ê·¸ë¨ì„ ì°¸ê³ í•˜ì—¬ êµ¬í˜„ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

---

## ğŸ› ë¬¸ì œ í•´ê²° (ê³µí†µ)

### ë¹„ë””ì˜¤ê°€ ì—…ë¡œë“œë˜ì§€ ì•Šì„ ë•Œ

- íŒŒì¼ í¬ê¸° ì œí•œ: 500MB  
- ì§€ì› í˜•ì‹: `.mp4`, `.avi`, `.mov`, `.mkv`

### ë¶„ì„ì´ ë„ˆë¬´ ì˜¤ë˜ ê±¸ë¦´ ë•Œ

- í”„ë ˆì„ ì¶”ì¶œ FPSë¥¼ ë‚®ì¶”ê¸° (ì˜ˆ: 5 â†’ 2â€“3)  
- ë¹„ë””ì˜¤ í•´ìƒë„/ê¸¸ì´ ì¶•ì†Œ  

### ROIê°€ ì˜ ê²€ì¶œë˜ì§€ ì•Šì„ ë•Œ

- `video_analyzer.py`ì˜ ìƒ‰ìƒ ë§ˆìŠ¤í‚¹ íŒŒë¼ë¯¸í„° ì¡°ì •  
- í†µí•© ê°€ì´ë“œ ë¬¸ì„œ ì°¸ê³ : `docs/INTEGRATED_GUIDE.md`

### VQA ê´€ë ¨ ì˜¤ë¥˜

- `"API Key Not Found"` â†’ `integrated_app.py`ì—ì„œ `GEMINI_API_KEY` í™˜ê²½ ë³€ìˆ˜ ì„¤ì • í™•ì¸  
- `"ë¶„ì„ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"` â†’ `outputs/{video_stem}/analysis_results.json` ì¡´ì¬ ì—¬ë¶€ í™•ì¸  
- `"AI ë‹µë³€ ìƒì„± ì‹¤íŒ¨"` â†’ LLM API ìƒíƒœ ë° ë„¤íŠ¸ì›Œí¬ í™•ì¸  

---

## ğŸ“ íìƒ‰ ì‹¬ê°ë„ ë¶„ë¥˜

| ì‹¬ê°ë„   | ê°ì†Œìœ¨     | ìƒ‰ìƒ        | ì„¤ëª…           |
|----------|------------|------------|----------------|
| Mild     | 30â€“50%     | ğŸŸ¡ ë…¸ë‘     | ê²½ë¯¸í•œ íìƒ‰    |
| Moderate | 50â€“70%     | ğŸŸ  ì£¼í™©     | ì¤‘ë“±ë„ íìƒ‰    |
| Severe   | 70â€“90%     | ğŸ”´ ë¹¨ê°•     | ì‹¬ê°í•œ íìƒ‰    |
| Critical | 90% ì´ìƒ   | âš« ì§„í•œ ë¹¨ê°• | ê±°ì˜/ì™„ì „ íìƒ‰ |

---

## ğŸ‘¨â€ğŸ’» ê°œë°œì ì •ë³´

- **í”„ë¡œì íŠ¸**: ìˆ˜ë©´ ë‚´ì‹œê²½ ê¸°ë„ íìƒ‰ ë¶„ì„ + VQA ì‹œìŠ¤í…œ  
- **ë²„ì „**: 2.0  
- **ë¼ì´ì„¼ìŠ¤**: MIT  
- **ê°œë°œ**: 2025ë…„ 11ì›”  

---

## ğŸ“§ ë¬¸ì˜

ê¸°ìˆ  ì§€ì›ì´ë‚˜ ë¬¸ì˜ì‚¬í•­ì€ ì´ìŠˆ íŠ¸ë˜ì»¤ë¥¼ í†µí•´ ì œì¶œí•´ì£¼ì„¸ìš”.

---

**Happy Analyzing & Asking! ğŸš€**
